{% comment %}
  Purpose: Full cart experience for the /cart template.
  - Supports rich layout, responsive styling, reassurance blocks, and order notes.
  - Built for the Musashi Challenge aesthetic using existing design tokens.
{% endcomment %}

<style>
  .cart_section {
    padding: var(--core-structure--section-large) 0 var(--core-structure--section-medium);
  }

  .cart_section .container-large {
    position: relative;
  }

  .cart_intro {
    width: 100%;
    gap: var(--_spacing---size--16);
    margin-bottom: var(--_spacing---size--48);
    max-width: 48rem;
  }

  .cart_intro-subheading {
    color: var(--color--text--dark--secondary);
    line-height: var(--_responsive---p-line-height--p-large);
  }

  .cart_intro-count {
    font-size: var(--_responsive---p-size--p-small);
    color: var(--color--text--dark--tertiary);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .cart_form {
    display: block;
  }

  .cart_form-messages {
    border: 1px solid var(--status-color--error-400);
    background: var(--status-color--error-200);
    color: var(--status-color--error-900);
    padding: var(--_spacing---size--16);
    margin-bottom: var(--_spacing---size--24);
    font-size: var(--_responsive---p-size--p-small);
  }

  .cart_layout {
    display: grid;
    grid-template-columns: minmax(0, 1.9fr) minmax(0, 1fr);
    gap: var(--_spacing---size--48);
    align-items: start;
  }

  .cart_items {
    display: grid;
    gap: var(--_spacing---size--24);
  }

  .cart_line-item {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: var(--_spacing---size--20);
    padding: var(--_spacing---size--24);
    background: var(--color--background--primary);
    border: 1px solid rgba(39, 35, 28, 0.12);
  }

  .cart_line-item-media {
    width: 7.25rem;
  }

  .cart_line-item-media-link {
    display: block;
    width: 100%;
    aspect-ratio: 1 / 1;
    overflow: hidden;
    background: var(--neutral--150);
    border: 1px solid rgba(39, 35, 28, 0.08);
  }

  .cart_line-item-media-link.is-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .cart_line-item-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .cart_line-item-content {
    display: grid;
    gap: var(--_spacing---size--16);
  }

  .cart_line-item-top {
    display: grid;
    gap: 0.4rem;
  }

  .cart_line-item-title {
    color: var(--color--text--dark--primary);
    text-decoration: none;
  }

  .cart_line-item-title:hover,
  .cart_line-item-title:focus {
    text-decoration: underline;
  }

  .cart_line-item-variant,
  .cart_line-item-vendor,
  .cart_line-item-sku {
    color: var(--color--text--dark--tertiary);
  }

  .cart_line-item-excerpt {
    color: var(--color--text--dark--secondary);
  }

  .cart_line-item-properties {
    display: grid;
    gap: 0.35rem;
  }

  .cart_line-item-property {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.5rem;
    font-size: var(--_responsive---p-size--p-small);
    color: var(--color--text--dark--secondary);
  }

  .cart_line-item-property dt {
    font-weight: 500;
  }

  .cart_line-item-pricing {
    display: grid;
    gap: 0.5rem;
  }

  .cart_line-item-price {
    display: flex;
    gap: 0.75rem;
    align-items: baseline;
  }

  .cart_line-item-price--compare {
    text-decoration: line-through;
    color: var(--color--text--dark--tertiary);
  }

  .cart_line-item-price--current {
    font-weight: 600;
    font-size: var(--_responsive---p-size--p-large);
  }

  .cart_line-item-discounts {
    display: grid;
    gap: 0.25rem;
    font-size: var(--_responsive---p-size--p-small);
    color: var(--brand--600);
  }

  .cart_line-item-unit {
    font-size: var(--_responsive---p-size--p-small);
    color: var(--color--text--dark--tertiary);
  }

  .cart_line-item-actions {
    display: grid;
    gap: 0.75rem;
  }

  .cart_quantity-control {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .cart_quantity-input {
    width: 5.5rem;
    border: 1px solid var(--neutral--300);
    background: var(--neutral--0);
    padding: 0.6rem 0.75rem;
    text-align: center;
    font-size: var(--_responsive---p-size--p-regular);
    font-family: var(--_typography---text-family--paragraph);
  }

  .cart_quantity-input::-webkit-outer-spin-button,
  .cart_quantity-input::-webkit-inner-spin-button {
    margin: 0;
    -webkit-appearance: none;
  }

  .cart_quantity-input[type='number'] {
    -moz-appearance: textfield;
  }

  .cart_quantity-note {
    font-size: var(--_responsive---p-size--p-small);
    color: var(--color--text--dark--tertiary);
  }

  .cart_line-item-remove {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: var(--_responsive---p-size--p-small);
    text-decoration: underline;
    text-decoration-thickness: 1px;
    color: var(--color--text--dark--secondary);
  }

  .cart_line-item-remove:hover,
  .cart_line-item-remove:focus {
    color: var(--brand--700);
  }

  .cart_summary-card {
    display: grid;
    gap: var(--_spacing---size--20);
    padding: var(--_spacing---size--32);
    background: var(--neutral--0);
    border: 1px solid rgba(39, 35, 28, 0.12);
    position: sticky;
    top: var(--_spacing---size--48);
  }

  .cart_summary-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 1rem;
  }

  .cart_summary-rows {
    display: grid;
    gap: var(--_spacing---size--16);
  }

  .cart_summary-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 1rem;
    font-size: var(--_responsive---p-size--p-regular);
  }

  .cart_summary-row.is-total {
    font-size: var(--_responsive---p-size--p-large);
    font-weight: 600;
  }

  .cart_summary-discounts {
    display: grid;
    gap: 0.4rem;
    font-size: var(--_responsive---p-size--p-small);
    color: var(--brand--600);
  }

  .cart_summary-notice {
    font-size: var(--_responsive---p-size--p-small);
    color: var(--color--text--dark--tertiary);
  }

  .cart_note {
    display: grid;
    gap: 0.5rem;
  }

  .cart_note textarea {
    min-height: 7rem;
    border: 1px solid var(--neutral--300);
    padding: 0.75rem 1rem;
    font-family: var(--_typography---text-family--paragraph);
    font-size: var(--_responsive---p-size--p-regular);
    resize: vertical;
  }

  .cart_summary-buttons {
    display: grid;
    gap: var(--_spacing---size--16);
  }

  .cart_summary-buttons .button_content {
    width: 100%;
    text-align: center;
  }

  .cart_summary-buttons button,
  .cart_summary-buttons a.button {
    width: 100%;
  }

  .cart_summary-buttons .button.is-secondary {
    padding: 0.75rem 2rem;
  }

  .cart_summary-continue {
    display: flex;
    justify-content: center;
    margin-top: var(--_spacing---size--8);
  }

  .cart_continue-link {
    font-size: var(--_responsive---p-size--p-small);
    text-decoration: underline;
    color: var(--color--text--dark--secondary);
  }

  .cart_continue-link:hover,
  .cart_continue-link:focus {
    color: var(--brand--700);
  }

  .cart_reassurance {
    display: grid;
    gap: var(--_spacing---size--16);
    padding: var(--_spacing---size--24);
    border: 1px solid rgba(39, 35, 28, 0.12);
    background: rgba(255, 255, 255, 0.7);
    margin-top: var(--_spacing---size--24);
  }

  .cart_reassurance-item {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: var(--_spacing---size--16);
    align-items: center;
  }

  .cart_reassurance-icon {
    width: 2.5rem;
    height: 2.5rem;
    background: var(--brand--100);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    border: 1px solid rgba(39, 35, 28, 0.1);
  }

  .cart_reassurance-icon img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .cart_reassurance-title {
    font-weight: 600;
    font-size: var(--_responsive---p-size--p-regular);
  }

  .cart_reassurance-body {
    font-size: var(--_responsive---p-size--p-small);
    color: var(--color--text--dark--secondary);
    margin-top: 0.25rem;
  }

  .cart_empty {
    display: grid;
    gap: var(--_spacing---size--24);
    justify-items: start;
  }

  .cart_empty-card {
    padding: var(--_spacing---size--32);
    border-radius: 1.5rem;
    border: 1px solid rgba(39, 35, 28, 0.12);
    background: var(--neutral--0);
    display: grid;
    gap: var(--_spacing---size--16);
    max-width: 36rem;
  }

  .cart_empty-card p {
    color: var(--color--text--dark--secondary);
  }

  .cart_empty-cta {
    display: inline-block;
  }

  .cart_quantity-actions {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .cart_quantity-submit {
    font-size: var(--_responsive---p-size--p-small);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    background: none;
    border: none;
    padding: 0;
    color: var(--brand--600);
    cursor: pointer;
  }

  .cart_quantity-submit:hover,
  .cart_quantity-submit:focus {
    color: var(--brand--700);
    text-decoration: underline;
  }

  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  @media (max-width: 1100px) {
    .cart_layout {
      grid-template-columns: 1fr;
    }

    .cart_summary-card {
      position: static;
    }
  }

  @media (max-width: 720px) {
    .cart_section {
      padding: var(--core-structure--section-medium) 0;
    }

    .cart_line-item {
      grid-template-columns: 1fr;
    }

    .cart_line-item-media {
      width: 100%;
    }

    .cart_line-item-media-link {
      max-width: 9rem;
    }

    .cart_line-item-actions {
      grid-template-columns: 1fr;
    }

    .cart_quantity-control {
      justify-content: flex-start;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .cart_summary-buttons .button,
    .cart_empty-cta,
    .cart_line-item-remove,
    .cart_quantity-submit {
      transition: none !important;
    }
  }
</style>

{% liquid
  assign heading = section.settings.heading | default: 'Review your items'
  assign subheading = section.settings.subheading | strip
  assign item_label_singular = section.settings.item_label_singular | default: 'item'
  assign item_label_plural = section.settings.item_label_plural | default: 'items'
  assign summary_heading = section.settings.summary_heading | default: 'Order summary'
  assign subtotal_label = section.settings.subtotal_label | default: 'Subtotal'
  assign total_label = section.settings.total_label | default: 'Estimated total'
  assign shipping_notice = section.settings.shipping_notice | strip
  if section.settings.show_taxes_notice
    if shipping_notice == ''
      if cart.taxes_included and cart.requires_shipping
        assign shipping_notice = 'Taxes included. Shipping calculated at checkout.'
      elsif cart.taxes_included
        assign shipping_notice = 'Taxes included. Shipping calculated at checkout.'
      elsif cart.requires_shipping
        assign shipping_notice = 'Taxes and shipping calculated at checkout.'
      else
        assign shipping_notice = 'Taxes calculated at checkout.'
      endif
    endif
  endif
%}

<section id="template-cart" class="cart_section">
  <div class="padding-global">
    <div class="container-large is-line">
      <div class='mid-line'></div>

      <div class="content-wrapper is-cart">
        <div class="cart_intro">
          <div class="spacer-xhuge"></div>
          <h2 class="heading-style-h3 text-align-center">{{ heading }}</h2>
        </div>

        {% if cart.item_count == 0 %}
          <div class="cart_empty">
            <div class="cart_empty-card">
              <h3 class="heading-style-h3">{{ section.settings.empty_heading | default: 'Your cart is empty' }}</h3>
              {% if section.settings.empty_body != blank %}
                <p class="text-size-regular">{{ section.settings.empty_body }}</p>
              {% endif %}
              {% assign empty_cta_label = section.settings.empty_cta_label | default: 'Browse products' %}
              {% assign empty_cta_url = section.settings.empty_cta_url | default: routes.all_products_collection_url %}
              {% if empty_cta_label != blank %}
                <a href="{{ empty_cta_url }}" class="button is-default cart_empty-cta w-inline-block">
                  <span class="button_line is-top"></span>
                  <span class="button_content">
                    <span class="text-size-regular is-primary">{{ empty_cta_label }}</span>
                  </span>
                  <span class="button_line is-bottom"></span>
                </a>
              {% endif %}
            </div>

            {% if section.blocks.size > 0 %}
              <div class="cart_reassurance">
                {% for block in section.blocks %}
                  <div class="cart_reassurance-item" {{ block.shopify_attributes }}>
                    {% if block.settings.icon != blank %}
                      <span class="cart_reassurance-icon">
                        {{ block.settings.icon | image_url: width: 80 | image_tag: loading: 'lazy', alt: block.settings.title | default: '' }}
                      </span>
                    {% endif %}
                    <div class="cart_reassurance-text">
                      {% if block.settings.title != blank %}
                        <p class="cart_reassurance-title">{{ block.settings.title }}</p>
                      {% endif %}
                      {% if block.settings.body != blank %}
                        <p class="cart_reassurance-body">{{ block.settings.body }}</p>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        {% else %}
          {% form 'cart'
            , cart
            , class: 'cart_form'
            , novalidate: 'novalidate' %}
            {% if form.errors %}
              <div class="cart_form-messages" role="alert">
                {{ form.errors | default_errors }}
              </div>
            {% endif %}

            <div class="cart_layout">
              <div class="cart_items">
                {% for item in cart.items %}
                  <article class="cart_line-item" data-key="{{ item.key }}">
                    <div class="cart_line-item-media">
                      {% if item.image %}
                        <a
                          href="{{ item.url }}"
                          class="cart_line-item-media-link"
                          aria-label="{{ item.product.title }}">
                          {{ item.image | image_url: width: 420, height: 420, crop: 'center' | image_tag: class: 'cart_line-item-image', loading: 'lazy', alt: item.image.alt | default: item.product.title }}
                        </a>
                      {% else %}
                        <div class="cart_line-item-media-link is-placeholder" aria-hidden="true">
                          <img
                            src="{{ 'Placeholder-Image.png' | asset_url }}"
                            alt=""
                            class="cart_line-item-image">
                        </div>
                      {% endif %}
                    </div>

                    <div class="cart_line-item-content">
                      <div class="cart_line-item-top">
                        <h3 class="text-size-xlarge">{{ item.product.title }}</h3>
                        {% if section.settings.show_item_vendor and item.product.vendor != blank %}
                          <p class="cart_line-item-vendor text-size-small">{{ item.product.vendor }}</p>
                        {% endif %}
                        {% if item.variant.title != 'Default Title' %}
                          <p class="cart_line-item-variant text-size-small">{{ item.variant.title }}</p>
                        {% endif %}
                        {% if section.settings.show_item_sku and item.sku != blank %}
                          <p class="cart_line-item-sku text-size-small">SKU: {{ item.sku }}</p>
                        {% endif %}
                        {% if item.selling_plan_allocation %}
                          <p class="cart_line-item-billing text-size-small">{{ item.selling_plan_allocation.selling_plan.name }}</p>
                        {% endif %}
                        {% if section.settings.show_item_excerpt and item.product.description != blank %}
                          <p class="cart_line-item-excerpt text-size-small">{{ item.product.description | strip_html | truncate: 140 }}</p>
                        {% endif %}
                      </div>

                      {% if item.properties.size > 0 %}
                        <dl class="cart_line-item-properties">
                          {% for property in item.properties %}
                            {% assign property_first_char = property.first | slice: 0, 1 %}
                            {% if property.last != blank and property_first_char != '_' %}
                              <div class="cart_line-item-property">
                                <dt>{{ property.first }}:</dt>
                                <dd>
                                  {% if property.last contains '/uploads/' %}
                                    <a href="{{ property.last }}">{{ property.last | split: '/' | last }}</a>
                                  {% else %}
                                    {{ property.last }}
                                  {% endif %}
                                </dd>
                              </div>
                            {% endif %}
                          {% endfor %}
                        </dl>
                      {% endif %}

                      <div class="cart_line-item-pricing">
                        <div class="text-size-large">
                          {% if item.original_line_price != item.final_line_price %}
                            <span class="text-size-large">{{ item.original_line_price | money }}</span>
                          {% endif %}
                          <span class="text-size-large">{{ item.final_line_price | money }}</span>
                        </div>

                        {% if item.line_level_discount_allocations.size > 0 %}
                          <ul class="cart_line-item-discounts">
                            {% for allocation in item.line_level_discount_allocations %}
                              <li>{{ allocation.discount_application.title }} (−{{ allocation.amount | money }})</li>
                            {% endfor %}
                          </ul>
                        {% endif %}

                        {% if item.unit_price_measurement %}
                          <p class="cart_line-item-unit">Unit price {{ item.unit_price | money }} / {{ item.unit_price_measurement.reference_value }}{{ item.unit_price_measurement.reference_unit }}</p>
                        {% endif %}
                      </div>

                      <div class="cart_line-item-actions">
                        <div class="cart_quantity-control">
                          <label class="visually-hidden" for="Cart-quantity-{{ forloop.index }}">Quantity for {{ item.product.title }}</label>
                          <input
                            class="cart_quantity-input"
                            id="Cart-quantity-{{ forloop.index }}"
                            name="updates[{{ item.key }}]"
                            type="number"
                            min="0"
                            value="{{ item.quantity }}"
                            inputmode="numeric">
                          <button
                            type="submit"
                            name="update"
                            class="cart_quantity-submit">{{ 'cart.update' | t }}</button>
                        </div>
                        <a href="{{ item.url_to_remove }}" class="cart_line-item-remove">{{ 'cart.remove' | t }}</a>
                      </div>
                    </div>
                  </article>
                {% endfor %}
              </div>

              <aside class="cart_summary-card" aria-label="{{ summary_heading }}">
                <div class="cart_summary-header">
                  <h3 class="text-size-xlarge">{{ summary_heading }}</h3>
                  <p class="text-size-small cart_intro-count">
                    {{ cart.item_count }} {{ cart.item_count | pluralize: item_label_singular, item_label_plural }}
                  </p>
                </div>
                <div class="cart_summary-rows">
                  <div class="cart_summary-row">
                    <span>{{ cart.subtotal_price | money }}</span>
                  </div>

                  {% if cart.cart_level_discount_applications.size > 0 %}
                    <div class="cart_summary-discounts">
                      {% for discount in cart.cart_level_discount_applications %}
                        <div class="cart_summary-row">
                          <span>{{ discount.title }}</span>
                          <span>−{{ discount.total_allocated_amount | money }}</span>
                        </div>
                      {% endfor %}
                    </div>
                  {% endif %}

                  <div class="cart_summary-row is-total">
                    <span>{{ total_label }}</span>
                    <span>{{ cart.total_price | money_with_currency }}</span>
                  </div>
                </div>


                {% if section.blocks.size > 0 %}
                  <div class="cart_reassurance">
                    {% for block in section.blocks %}
                      <div class="cart_reassurance-item" {{ block.shopify_attributes }}>
                        {% if block.settings.icon != blank %}
                          <span class="cart_reassurance-icon">
                            {{ block.settings.icon | image_url: width: 80 | image_tag: loading: 'lazy', alt: block.settings.title | default: '' }}
                          </span>
                        {% endif %}
                        <div class="cart_reassurance-text">
                          {% if block.settings.title != blank %}
                            <p class="cart_reassurance-title">{{ block.settings.title }}</p>
                          {% endif %}
                          {% if block.settings.body != blank %}
                            <p class="cart_reassurance-body">{{ block.settings.body }}</p>
                          {% endif %}
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}
              </aside>
            </div>
          {% endform %}
        {% endif %}

      </div>
      <div class='mid-line'></div>
    </div>
  </div>
</section>

{% schema %}
  {
    "name": "Cart",
    "class": "section-cart",
    "settings": [
      {
        "type": "text",
        "id": "heading",
        "label": "Heading",
        "default": "Review your items"
      },
      {
        "type": "textarea",
        "id": "subheading",
        "label": "Supporting copy",
        "default": "Every item moves you closer to unbreakable discipline."
      },
      {
        "type": "text",
        "id": "item_label_singular",
        "label": "Item label (singular)",
        "default": "item"
      },
      {
        "type": "text",
        "id": "item_label_plural",
        "label": "Item label (plural)",
        "default": "items"
      }, {
        "type": "text",
        "id": "summary_heading",
        "label": "Summary heading",
        "default": "Order summary"
      }, {
        "type": "text",
        "id": "subtotal_label",
        "label": "Subtotal label",
        "default": "Subtotal"
      }, {
        "type": "text",
        "id": "total_label",
        "label": "Total label",
        "default": "Estimated total"
      }, {
        "type": "checkbox",
        "id": "show_taxes_notice",
        "label": "Show shipping and tax notice",
        "default": true
      }, {
        "type": "textarea",
        "id": "shipping_notice",
        "label": "Custom shipping/tax notice",
        "info": "Leave blank to generate an automatic notice based on tax settings."
      }, {
        "type": "checkbox",
        "id": "show_cart_note",
        "label": "Enable order note",
        "default": true
      }, {
        "type": "text",
        "id": "cart_note_label",
        "label": "Order note label",
        "default": "Add a note for the team"
      }, {
        "type": "textarea",
        "id": "cart_note_placeholder",
        "label": "Order note placeholder",
        "default": "Anything we should know before we prepare your kit?"
      }, {
        "type": "url",
        "id": "continue_shopping_link",
        "label": "Continue shopping link"
      }, {
        "type": "text",
        "id": "continue_shopping_label",
        "label": "Continue shopping label",
        "default": "Continue shopping"
      }, {
        "type": "text",
        "id": "checkout_button_label",
        "label": "Checkout button label",
        "default": "Checkout"
      }, {
        "type": "text",
        "id": "empty_heading",
        "label": "Empty state heading",
        "default": "Your cart is empty"
      }, {
        "type": "textarea",
        "id": "empty_body",
        "label": "Empty state body",
        "default": "Keep exploring the Musashi Challenge to add products."
      }, {
        "type": "text",
        "id": "empty_cta_label",
        "label": "Empty state button label",
        "default": "Browse products"
      }, {
        "type": "url",
        "id": "empty_cta_url",
        "label": "Empty state button link"
      }, {
        "type": "checkbox",
        "id": "show_item_vendor",
        "label": "Show product vendor",
        "default": false
      }, {
        "type": "checkbox",
        "id": "show_item_sku",
        "label": "Show product SKU",
        "default": false
      }, {
        "type": "checkbox",
        "id": "show_item_excerpt",
        "label": "Show product excerpt",
        "default": false
      }
    ],
    "blocks": [
      {
        "type": "reassurance",
        "name": "Reassurance",
        "settings": [
          {
            "type": "image_picker",
            "id": "icon",
            "label": "Icon"
          }, {
            "type": "text",
            "id": "title",
            "label": "Title",
            "default": "Secure checkout"
          }, {
            "type": "textarea",
            "id": "body",
            "label": "Body",
            "default": "256-bit encryption keeps your payment safe."
          }
        ]
      }
    ],
    "max_blocks": 4,
    "presets": [
      {
        "name": "Cart",
        "category": "Cart"
      }
    ]
  }
{% endschema %}